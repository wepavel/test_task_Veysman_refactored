# Файловое хранилище

---

## Установка

___

###  docker-compose.yml

```yaml
services:
  backend:
    container_name: files
    image: 'backend:latest'
    depends_on:
      - test_db
    build:
      context: ./
    volumes:
      - .:/src/
      - /etc/localtime:/etc/localtime:ro
    restart: always
    ports:
      - "8023:8001"
    command: ["python", "./src/app.py"]

  postgres:
    container_name: database
    image: postgres:17-bookworm
    volumes:
      - test_pgdata:/var/lib/postgresql/data/pgdata
      - /etc/localtime:/etc/localtime:ro
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
      - POSTGRES_USER=postgres
      - POSTGRES_DB=postgres
      - POSTGRES_PASSWORD=postgres
    restart: always
    expose:
      - 5432
    ports:
      - "5434:5432"
volumes:
  test_pgdata:
```

. `docker compose up -d`

### Пояснение к акхитект1уре

Приложение представляет из себя файловое хранилище, имеющее публичный API для взаимодействия.

### config.yaml

```yaml
pg:
  host: database
  port: 5432
  user: postgres
  password: postgres
  database: database
  schema: 'external_modules'

storage_dir: file_storage

file_config:
  upload_chunk_size: 5242880
```

### Переменные окружения (опциональные)

- YAML_PATH=/config.yaml

## API

---


### Загрузка файла
**Описание:** Позволяет загрузить файл в файловое хранилище по указанному пути.

`POST /api/files/{dir_path}`

**Запрос** `multipart/form-data`
- **Path-параметр**
  - `dir_path` — относительный путь к папке внутри файлового хранилища, например: `images/profile`. 
- **Form-data:**

| Поле       | Тип  | Описание          |
|------------|------|-------------------|
| input_file | файл | Файл для загрузки |


**Ответ** `application/json` `200 OK`

```json5
{
  // Имя файла
  "name": "README",
  // Расширение файла
  "extension": ".md",
  // Относительный путь файла внутри файловой системы
  "path": "",
  // Размер файла
  "size": 12439,
  // Дата добавления файла в хранилище
  "created_at": "2025-06-30T16:13:47.120937+03:00",
  // Дата последнего изменения файла
  "updated_at": "2025-06-30T16:13:47.120940+03:00",
  // Комментарий к файлу
  "comment": ""
}
```

**Ошибки**:

- `400` - указанный путь ведёт за пределы базовой директории хранилища;
- `409` - файл с таким именем уже существует;
- `500` - ошибка при загрузке файла в хранилище;
- `500` - прочие ошибки.


### Изменение файла
**Описание:** Позволяет произвести изменение разрешённых параметров файла в хранилище.

`PATCH /api/files/{id}`

**Запрос** `application/json`
- **Path-параметр**
  - `id` — идентификатор файла, выданный ему при загрузке в хранилище
- **JSON тело запроса (`FileUpdate`):**

```json5
{
  "name": "new_name",
  "new_dir_path": "images/updated",
  "comment": "Новое описание изображения"
}
```
Каждое из полей является опциональным для того, чтобы каждый из этих параметров можно было изменить отдельно.

**Ответ** `application/json` `200 OK`

Аналогичен ответу при загрузке файла в хранилище

**Ошибки**:

- `400` - указанный путь ведёт за пределы базовой директории хранилища;
- `409` - файла с таким именем не существует;
- `404` - ошибка с таким именем уже существует;
- `500` - ошибка при перемещении файла;
- `500` - прочие ошибки.


### Получение файла

**Описание:** Позволяет выполнить загрузку существующего файла из хранилища.

`GET /api/files/{id}/download`

**Запрос** `application/json`
- **Path-параметр**
  - `id` — идентификатор файла, выданный ему при загрузке в хранилище

**Ответ** `application/octet-stream` `200 OK`

Файл сохраняется клиентом под оригинальным именем.

**Ошибки**:

- `400` - указанный путь ведёт за пределы базовой директории хранилища;
- `404` - файла с таким именем не существует;
- `500` - ошибка при загрузке файла;
- `500` - прочие ошибки.


### Удаление файла

`DELETE /api/files/{id}`

**Запрос** `application/json`
- **Path-параметр**
  - `id` — идентификатор файла, выданный ему при загрузке в хранилище

**Ответ** `application/json` `200 OK`

Аналогичен ответу при загрузке файла в хранилище

**Ошибки**:

- `400` - указанный путь ведёт за пределы базовой директории хранилища;
- `404` - файла с таким именем не существует;
- `500` - прочие ошибки.


### Получение сведений о файле

**Описание:** Возвращает сведения о файле, путь к которому был указан в запросе.

`GET /api/files/{id}`

**Запрос** `application/json`
- **Path-параметр**
  - `id` — идентификатор файла, выданный ему при загрузке в хранилище

**Ответ** `application/json` `200 OK`

Аналогичен ответу при загрузке файла в хранилище

**Ошибки**:

- `400` - указанный путь ведёт за пределы базовой директории хранилища;
- `404` - файла с таким именем не существует;
- `500` - прочие ошибки.


### Получение сведений о файлах

**Описание:** Возвращает список всех файлов, хранящихся в базе данных, с постраничной пагинацией. 

`GET /api/files`

**Запрос** `application/json`
- **Query-параметр**
  - `for_dir` — Путь к папке в файловом хранилище, в которой необходимо получить список файлов. Опциональный параметр - если не указан, то будет возвращён список всех файлов в хранилище.
  - `skip` — Количество файлов, которые нужно пропустить `(offset)`. Опциональный параметр - если не указан, то значение по умолчанию 0.
  - `limit` — Максимальное количество файлов в ответе. Опциональный параметр - если не указан, то значение по умолчанию 10.

**Ответ** `application/json` `200 OK`

Аналогичен ответу при запросе сведений о файлах, лежащих в заданной папке

- `400` - указанный путь ведёт за пределы базовой директории хранилища;
- `500` - прочие ошибки.